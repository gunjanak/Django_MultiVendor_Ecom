{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <h2 class="mt-5 mb-4">Product List</h2>
</div>

<button id="toggleButton" class="btn btn-primary mb-3">
    Switch to Services
</button>
<div id="content-list" class="row">

</div>
<div id="loading-message" class="text-center mt-3">
    Loading more
</div>


<script>
    $(document).ready(function(){
        var allData = [];
        var loadedData = 0;
        var dataPerPage = 6;
        var isLoading = false;
        var loadTriggred = true;
        var currentUrl = '/products/';

        function loadData() {
            if (isLoading || !loadTriggred){
                return;
            }

            isLoading = true;

            //Get the next set of products based on the current offset
            var nextData = allData.slice(loadedData,loadedData+dataPerPage);
            //Loop through the next set of products and them to the list
            for(var i=0; i<nextData.length; i++){
                //Create a bootstrap card for each product
                var dataCard = $('<div>').addClass('col-md-4 mb-4');
                dataCard.append('<div class="card">');
                
                //Create an image element and set its source to product's image URL
                if(nextData[i].image){
                    var image = $('<img>').addClass('card-img-top').attr('src',''+nextData[i].image);

                }else {
                    var imageSrc = "{% static 'images/no_image.png' %}";
                    var image = $('<img>').addClass('card-img-top').attr('src',imageSrc);
                }
               
                var dataId = nextData[i].id;
                console.log(typeof dataId);

                if(currentUrl === '/products/'){
                    var dataUrl = "{% url 'product_detail' 1%}"

                }else {
                    var dataUrl = "{% url 'service_detail' 1%}"
                }
                
                dataUrl = dataUrl.replace('1',dataId);
                console.log(dataUrl);
                var detailsLink = $('<a>').attr('href', dataUrl).addClass('btn btn-primary').text('Details');

                

               
                


                
                
                
                //Create a card body
                var cardBody = $('<div>').addClass('card-body');
                cardBody.append('<h5 class="card-title">'+nextData[i].item_name+'</h5>');
                cardBody.append(detailsLink);

                
                //Append the image and card body to the card
                dataCard.append(image);
                dataCard.append(cardBody);

                //Append the productcard to the list 
                $('#content-list').append(dataCard);
                loadedData++;

            }

            isLoading = false;

            //Hide loading message if no more products
            if(loadedData >= allData.length){
                $('#loading-message').text("No more products to load");
            } else {
                $("#loading-message").text("loading");
            }

            loadTriggred = false;

        }

        function switchUrl(){
            if(currentUrl === '/products/'){
                currentUrl = '/services/';
            }
            else {
                currentUrl = '/products/';
            }

            //Reset loaded data
            loadedData = 0;

            //Clear contetn list
            $('#content-list').empty();

            //Trigger data loading
            loadTriggred = true;

            loadDataFromUrl(currentUrl);
            //Update button text
            updateButtonText();

        }

        function loadDataFromUrl(url){
            //simulate getting all products from Django backend and storing them in allProducts array
            $.ajax({
                url:currentUrl,
                type:'GET',
                success:function(data){
                    allData = data;
                    loadData();
                }
            });
        }

        function updateButtonText(){
            var buttonText = currentUrl === '/products/' ? 'Switch to Services': 'Switch to Products';
            $('#toggleButton').text(buttonText);

        }

        loadDataFromUrl(currentUrl);

        //Load more products as the user scrolls down
        $(window).scroll(function () {
            if($(window).scrollTop() + $(window).height() >= $(document).height() - 200 && !isLoading) {
                loadTriggred = true;
                setTimeout(loadData,2000);
            }
        });

        //Add click event for the toggle button
        $('#toggleButton').click(function (){
            switchUrl();
        });
    });
</script>
{% endblock %}